<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/hexo_blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/hexo_blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/hexo_blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/hexo_blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/hexo_blog/css/main.css">


<link rel="stylesheet" href="/hexo_blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sallyslove.github.io","root":"/hexo_blog/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="å‚è€ƒé“¾æ¥  å…³äºCassandraçš„åˆ é™¤å’Œå¢“ç¢‘ æœ€æ–°å®˜æ–¹æ–‡æ¡£ï¼Œéå¸¸æ¸…æ¥š æœ‰ä¸Šç¯‡æ–‡ç« çš„ç¿»è¯‘ Cassandra çš„å‹ç¼©ç­–ç•¥STCSï¼ŒLCS å’Œ DTCS  Delete Data  æ‰¾äº†ä¸€ä¸‹åšå®¢ï¼Œå‘ç°å±…ç„¶éƒ½æ²¡æœ‰ä¸€ä¸ªç« èŠ‚æ˜¯å…³äºåˆ é™¤æ•°æ®çš„ äº‹å®ä¸Šï¼ŒCassandraé‡Œé¢çš„åˆ é™¤æ˜¯ä¸€ç§å†™æ“ä½œï¼Œä¼šæ’å…¥å¢“ç¢‘ã€‚åœ¨ä¸Šé¢çš„å‚åŠ é“¾æ¥é‡Œé¢è¯¦å°½æè¿°äº†è¿™ä¸ªè¿‡ç¨‹ å¯ä»¥ä½¿ç”¨SSTabledumpå‘½ä»¤æ¥è¿›è¡ŒæŸ¥è¯¢ã€‚ä½†æ˜¯å¹¶æ²¡æœ‰åœ¨æˆ‘ä»¬çš„">
<meta property="og:type" content="article">
<meta property="og:title" content="Cassandra Maintain">
<meta property="og:url" content="https://sallyslove.github.io/hexo_blog/2019/06/25/Cassandra_Maintain/index.html">
<meta property="og:site_name" content="è·¬æ­¥">
<meta property="og:description" content="å‚è€ƒé“¾æ¥  å…³äºCassandraçš„åˆ é™¤å’Œå¢“ç¢‘ æœ€æ–°å®˜æ–¹æ–‡æ¡£ï¼Œéå¸¸æ¸…æ¥š æœ‰ä¸Šç¯‡æ–‡ç« çš„ç¿»è¯‘ Cassandra çš„å‹ç¼©ç­–ç•¥STCSï¼ŒLCS å’Œ DTCS  Delete Data  æ‰¾äº†ä¸€ä¸‹åšå®¢ï¼Œå‘ç°å±…ç„¶éƒ½æ²¡æœ‰ä¸€ä¸ªç« èŠ‚æ˜¯å…³äºåˆ é™¤æ•°æ®çš„ äº‹å®ä¸Šï¼ŒCassandraé‡Œé¢çš„åˆ é™¤æ˜¯ä¸€ç§å†™æ“ä½œï¼Œä¼šæ’å…¥å¢“ç¢‘ã€‚åœ¨ä¸Šé¢çš„å‚åŠ é“¾æ¥é‡Œé¢è¯¦å°½æè¿°äº†è¿™ä¸ªè¿‡ç¨‹ å¯ä»¥ä½¿ç”¨SSTabledumpå‘½ä»¤æ¥è¿›è¡ŒæŸ¥è¯¢ã€‚ä½†æ˜¯å¹¶æ²¡æœ‰åœ¨æˆ‘ä»¬çš„">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://docs.datastax.com/en/cassandra/3.0/cassandra/images/dml_compaction.png">
<meta property="article:published_time" content="2019-06-25T09:01:57.000Z">
<meta property="article:modified_time" content="2021-02-22T08:24:25.088Z">
<meta property="article:author" content="Lynn Shen">
<meta property="article:tag" content="Cassandra">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://docs.datastax.com/en/cassandra/3.0/cassandra/images/dml_compaction.png">

<link rel="canonical" href="https://sallyslove.github.io/hexo_blog/2019/06/25/Cassandra_Maintain/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Cassandra Maintain | è·¬æ­¥</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/hexo_blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">è·¬æ­¥</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">ä¸ç§¯è·¬æ­¥ï¼Œæ— ä»¥è‡³åƒé‡Œ</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/hexo_blog/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/hexo_blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://sallyslove.github.io/hexo_blog/2019/06/25/Cassandra_Maintain/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/hexo_blog/images/avatar.gif">
      <meta itemprop="name" content="Lynn Shen">
      <meta itemprop="description" content="35å²å¼€å§‹çš„åšå®¢ï¼Œæœ‰ç‚¹æ™šå“¦">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="è·¬æ­¥">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Cassandra Maintain
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-06-25 17:01:57" itemprop="dateCreated datePublished" datetime="2019-06-25T17:01:57+08:00">2019-06-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-02-22 16:24:25" itemprop="dateModified" datetime="2021-02-22T16:24:25+08:00">2021-02-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/hexo_blog/categories/cassandra/" itemprop="url" rel="index"><span itemprop="name">cassandra</span></a>
                </span>
            </span>

          
            <span id="/hexo_blog/2019/06/25/Cassandra_Maintain/" class="post-meta-item leancloud_visitors" data-flag-title="Cassandra Maintain" title="é˜…è¯»æ¬¡æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valineï¼š</span>
    
    <a title="valine" href="/hexo_blog/2019/06/25/Cassandra_Maintain/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/hexo_blog/2019/06/25/Cassandra_Maintain/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="å‚è€ƒé“¾æ¥"><a class="header-anchor" href="#å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2>
<ul>
<li><a href="https://thelastpickle.com/blog/2016/07/27/about-deletes-and-tombstones.html" target="_blank" rel="noopener">å…³äºCassandraçš„åˆ é™¤å’Œå¢“ç¢‘</a></li>
<li><a href="http://cassandra.apache.org/doc/latest/operating/compaction.html#defragmentation" target="_blank" rel="noopener">æœ€æ–°å®˜æ–¹æ–‡æ¡£ï¼Œéå¸¸æ¸…æ¥š</a></li>
<li><a href="https://zhaoyanblog.com/archives/966.html" target="_blank" rel="noopener">æœ‰ä¸Šç¯‡æ–‡ç« çš„ç¿»è¯‘</a></li>
<li><a href="https://www.cnblogs.com/didda/p/4728588.html" target="_blank" rel="noopener">Cassandra çš„å‹ç¼©ç­–ç•¥STCSï¼ŒLCS å’Œ DTCS</a></li>
</ul>
<h2 id="delete-data"><a class="header-anchor" href="#delete-data"></a>Delete Data</h2>
<ul>
<li>æ‰¾äº†ä¸€ä¸‹åšå®¢ï¼Œå‘ç°å±…ç„¶éƒ½æ²¡æœ‰ä¸€ä¸ªç« èŠ‚æ˜¯å…³äºåˆ é™¤æ•°æ®çš„</li>
<li>äº‹å®ä¸Šï¼Œ<code>Cassandra</code>é‡Œé¢çš„åˆ é™¤æ˜¯ä¸€ç§å†™æ“ä½œï¼Œä¼šæ’å…¥å¢“ç¢‘ã€‚åœ¨ä¸Šé¢çš„å‚åŠ é“¾æ¥é‡Œé¢è¯¦å°½æè¿°äº†è¿™ä¸ªè¿‡ç¨‹</li>
<li>å¯ä»¥ä½¿ç”¨<code>SSTabledump</code>å‘½ä»¤æ¥è¿›è¡ŒæŸ¥è¯¢ã€‚<strong><em>ä½†æ˜¯å¹¶æ²¡æœ‰åœ¨æˆ‘ä»¬çš„ç¯å¢ƒä¸­æ‰¾åˆ°è¿™ä¸ªå‘½ä»¤</em></strong></li>
<li>éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œè®¨è®ºçš„éƒ½æ˜¯åˆ é™¤ä¹‹åå†<code>flush</code>åˆ°<code>SSTable</code>é‡Œçš„æƒ…å†µï¼Œ<code>Memtable</code>é‡Œé¢çš„æ•°æ®åˆ é™¤ä¼šæœ‰æ‰€ä¸ç—›</li>
<li><code>gc_grace_seconds</code>ï¼šåœ¨åˆ é™¤æ•°æ®ä¹‹åä¼šä¿å­˜ä¸€æ®µæ—¶é—´çš„å¢“ç¢‘ï¼Œä»¥æ­¤æ¥ä¿è¯æ•°æ®åŒæ­¥ã€‚</li>
</ul>
<h3 id="åˆ é™¤æŸä¸€è¡Œçš„æŸä¸ªæ•°æ®"><a class="header-anchor" href="#åˆ é™¤æŸä¸€è¡Œçš„æŸä¸ªæ•°æ®"></a>åˆ é™¤æŸä¸€è¡Œçš„æŸä¸ªæ•°æ®</h3>
<ul>
<li>
<p>å¯ä»¥åªåˆ é™¤æŸä¸€è¡Œçš„æŸä¸€ä¸ªæ•°æ®ï¼Œå¦‚ä¸‹</p>
</li>
<li>
<p>å½“åˆ é™¤æ‰æŸä¸€è¡Œçš„æŸä¸ªæ•°æ®çš„æ—¶å€™ï¼Œä½¿ç”¨ä¸Šé¢çš„<code>SSTabledump</code>å‘½ä»¤ï¼Œè¿™ä¸€è¡Œæ•°æ®å°†æ²¡æœ‰<code>liveness_info</code></p>
<pre><code>DELETE crates FROM tlp_lab.tombstones WHERE fruit='apple' AND date ='20160617';
</code></pre>
</li>
</ul>
<p>é‚£ä¹ˆè¿™ä¸ªæ•°æ®ä¼šæ˜¾ç¤º<code>null</code></p>
<pre><code>  alain$ echo &quot;SELECT * FROM tlp_lab.tombstones LIMIT 100;&quot; | cqlsh
  fruit   | date     | crates
  ---------+----------+-----------------
  apple | 20160617 |            null
</code></pre>
<h3 id="åˆ é™¤ä¸€è¡Œçš„æ•°æ®"><a class="header-anchor" href="#åˆ é™¤ä¸€è¡Œçš„æ•°æ®"></a>åˆ é™¤ä¸€è¡Œçš„æ•°æ®</h3>
<ul>
<li>
<p>åˆ é™¤æ‰ä¸€è¡Œä¹‹åï¼Œè¿™ä¸€è¡Œçš„æ•°æ®çš„<code>cell</code>ä¹Ÿå°†æ²¡æœ‰ä»»ä½•æ•°æ®</p>
<pre><code>&quot;rows&quot; : [
{
  &quot;type&quot; : &quot;row&quot;,
  &quot;position&quot; : 19,
  &quot;clustering&quot; : [ &quot;20160617&quot; ],
  &quot;deletion_info&quot; : { &quot;marked_deleted&quot; : &quot;2016-06-16T19:31:41.142454Z&quot;, &quot;local_delete_time&quot; : &quot;2016-06-16T19:31:41Z&quot; },
  &quot;cells&quot; : [ ]
}

&quot;rows&quot; : [
{
  &quot;type&quot; : &quot;row&quot;,
  &quot;position&quot; : 125,
  &quot;clustering&quot; : [ &quot;20160616&quot; ],
  &quot;liveness_info&quot; : { &quot;tstamp&quot; : &quot;2016-06-16T18:52:41.903751Z&quot;, &quot;ttl&quot; : 2592000, &quot;expires_at&quot; : &quot;2016-07-16T18:52:41Z&quot;, &quot;expired&quot; : false },
  &quot;cells&quot; : [
    { &quot;name&quot; : &quot;crates&quot;, &quot;deletion_info&quot; : { &quot;marked_deleted&quot; : &quot;2016-06-16T18:52:41.903750Z&quot;, &quot;local_delete_time&quot; : &quot;2016-06-16T18:52:41Z&quot; } },
    { &quot;name&quot; : &quot;crates&quot;, &quot;path&quot; : [ &quot;6&quot; ], &quot;value&quot; : &quot;&quot; },
    { &quot;name&quot; : &quot;crates&quot;, &quot;path&quot; : [ &quot;7&quot; ], &quot;value&quot; : &quot;&quot; },
    { &quot;name&quot; : &quot;crates&quot;, &quot;path&quot; : [ &quot;8&quot; ], &quot;value&quot; : &quot;&quot; }
  ]
}
</code></pre>
</li>
</ul>
<h3 id="åˆ é™¤ä¸€ä¸ªèŒƒå›´å†…çš„æ•°æ®"><a class="header-anchor" href="#åˆ é™¤ä¸€ä¸ªèŒƒå›´å†…çš„æ•°æ®"></a>åˆ é™¤ä¸€ä¸ªèŒƒå›´å†…çš„æ•°æ®</h3>
<ul>
<li>
<p>è¿™ä¸ªå«ä¹‰å°±æ˜¯ï¼Œæ¯”å¦‚ä¸‹é¢çš„å‘½ä»¤ï¼Œè¿™æ ·å¯ä»¥ä¸€æ¬¡æ€§åˆ é™¤å¥½å‡ è¡Œæ•°æ®</p>
<pre><code>DELETE FROM tlp_lab.tombstones WHERE fruit='apple' AND date &gt; '20160615';
</code></pre>
</li>
<li>
<p>é‚£ä¹ˆå­˜ä¸‹æ¥çš„æ•°æ®ä¼šå˜ä¸ºï¼Œ<code>type</code>å˜åŒ–äº†</p>
<pre><code>&quot;rows&quot; : [
    {
      &quot;type&quot; : &quot;range_tombstone_bound&quot;,
      &quot;start&quot; : {
        &quot;type&quot; : &quot;exclusive&quot;,
        &quot;clustering&quot; : [ &quot;20160615&quot; ],
        &quot;deletion_info&quot; : { &quot;marked_deleted&quot; : &quot;2016-06-16T19:53:21.133300Z&quot;, &quot;local_delete_time&quot; : &quot;2016-06-16T19:53:21Z&quot; }
      }
    },
    {
      &quot;type&quot; : &quot;range_tombstone_bound&quot;,
      &quot;end&quot; : {
        &quot;type&quot; : &quot;inclusive&quot;,
        &quot;deletion_info&quot; : { &quot;marked_deleted&quot; : &quot;2016-06-16T19:53:21.133300Z&quot;, &quot;local_delete_time&quot; : &quot;2016-06-16T19:53:21Z&quot; }
      }
</code></pre>
</li>
</ul>
<h3 id="åˆ é™¤ä¸€ä¸ªpartitionçš„æ•°æ®"><a class="header-anchor" href="#åˆ é™¤ä¸€ä¸ªpartitionçš„æ•°æ®"></a>åˆ é™¤ä¸€ä¸ªpartitionçš„æ•°æ®</h3>
<ul>
<li>
<p>å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre><code>DELETE FROM tlp_lab.tombstones WHERE fruit='pickles';
</code></pre>
<p>ä¼šåœ¨<code>partition</code>çš„åœ°æ–¹åŠ å…¥<code>deletion_info</code>ï¼Œè€Œé€šå¸¸æƒ…å†µä¸‹åªæœ‰<code>key</code>å’Œ<code>position</code></p>
<pre><code>{
  &quot;partition&quot; : {
    &quot;key&quot; : [ &quot;pickles&quot; ],
    &quot;position&quot; : 0,
    &quot;deletion_info&quot; : { &quot;marked_deleted&quot; : &quot;2016-06-17T09:38:52.550841Z&quot;, &quot;local_delete_time&quot; : &quot;2016-06-17T09:38:52Z&quot; }
}
  
&quot;partition&quot; : {
   &quot;key&quot; : [ &quot;apple&quot; ],
   &quot;position&quot; : 0
},  
</code></pre>
</li>
</ul>
<h3 id="é›†åˆæ•°æ®"><a class="header-anchor" href="#é›†åˆæ•°æ®"></a>é›†åˆæ•°æ®</h3>
<ul>
<li>éœ€è¦é¢å¤–æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœä½¿ç”¨é›†åˆæ•°æ®ï¼Œæ¯”å¦‚<code>list</code>ï¼Œé‚£ä¹ˆåœ¨æ›´æ–°çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€ä¸ªæ½œåœ¨çš„åˆ é™¤æ“ä½œã€‚ä¼šå°†æ—§çš„æ•°æ®åˆ é™¤ï¼Œè¿™ä¸€ç‚¹éå¸¸æ¼äººï¼Œéœ€è¦æ³¨æ„</li>
</ul>
<h3 id="gc-grace-secondså‚æ•°"><a class="header-anchor" href="#gc-grace-secondså‚æ•°"></a>gc_grace_secondså‚æ•°</h3>
<ul>
<li><code>gc_grace_seconds</code>å‚æ•°çš„é»˜è®¤å€¼ä¸º10å¤©ï¼Œè¿™ä¸ªå‚æ•°çš„æ„æ€å°±æ˜¯è¿™ä¸ªæ•°æ®è¢«åˆ é™¤ä¹‹åï¼Œç›¸åº”çš„<code>tombstone</code>ä¹Ÿä¸ä¼šç«‹åˆ»åœ¨<code>compaction</code>ä¸­è¢«ç§»é™¤</li>
<li>è¿™ä¸ªå€¼çš„ç›®çš„æ˜¯ä¸ºäº†ä¿è¯åˆ é™¤çš„ä¸€è‡´æ€§ã€‚ä»¥é˜²æœ‰çš„èŠ‚ç‚¹ä¸Šé¢åˆ é™¤å¤±è´¥ï¼Œå‡ºç°å¹½çµæ•°æ®ã€‚åœ¨ç»´æŠ¤æ“ä½œç« èŠ‚ä¸­æœ‰è¿›ä¸€æ­¥çš„è§£é‡Šã€‚å‡è®¾æœ‰åˆ é™¤å¤±è´¥ï¼Œç„¶åå®¢æˆ·åšäº†<code>repair</code>æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°æ®ä¼šè¢«å¤åˆ¶åˆ°å·²ç»åˆ é™¤çš„èŠ‚ç‚¹ä¸Šé¢ã€‚é‚£ä¹ˆå°±é”™äº†ã€‚ç›¸åï¼Œå¦‚æœæ˜¯æ’å¢“ç¢‘ï¼Œå³ä½¿æœ‰èŠ‚ç‚¹æ²¡æ’ä¸Šï¼Œ<code>repair</code>çš„æ—¶å€™ä¹Ÿåªä¼šå¤åˆ¶ä¸ªå¢“ç¢‘è¿‡å»ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦éœ€è¦ç»´æŒä¸€é˜µå¢“ç¢‘</li>
</ul>
<h2 id="ç»´æŠ¤æ“ä½œ"><a class="header-anchor" href="#ç»´æŠ¤æ“ä½œ"></a>ç»´æŠ¤æ“ä½œ</h2>
<ul>
<li><code>minor compaction</code>: è¿™ä¸ªå°±æ˜¯<code>C#</code>è‡ªå·±åšçš„å‹ç¼©</li>
<li><code>major compaction</code>: è¿™ä¸ªå°±æ˜¯æ‰‹åŠ¨çš„ç”¨<code>nodetool</code>åšçš„ï¼Œä¼šå¯¹æ‰€æœ‰çš„å½“å‰<code>node</code>ä¸Šé¢çš„<code>SSTable</code>è¿›è¡Œå‹ç¼©</li>
<li><code>user defined compaction</code>ï¼š å®¢æˆ·è‡ªå®šä¹‰çš„ï¼Œå¯¹éƒ¨åˆ†<code>SSTable</code>è¿›è¡Œå‹ç¼©ã€‚ç”¨æˆ·å¯ä»¥åªé’ˆå¯¹ä¸€å¼ è¡¨æ¥åšå‹ç¼©ï¼ŒCassandraä¼šå¯¹æ•°æ®è¿›è¡Œæ ¡éªŒï¼Œä½¿ç”¨<code>unchecked_tombstone_compaction</code> å‚æ•°å¯ä»¥è·³è¿‡è¿™ä¸ªæ ¡éªŒè¿‡ç¨‹</li>
<li><code>Scrub</code>: è¿™ä¸ªæ“ä½œä¼šå°è¯•ä¿®å¤<code>SSTable</code>ï¼Œæ‰€ä»¥è¿™ä¸ªåŠ¨ä½œæœ‰å¯èƒ½ä¼šåˆ é™¤æœ‰æ•ˆä½†æ˜¯å·²ç»åæ‰çš„æ•°æ®ï¼Œå¦‚æœè¿™ä¸ªå‘ç”Ÿï¼Œå¾—ç”¨<code>repair</code>æ¥ä¿®å¤</li>
<li>åœ¨ä»¥ä¸‹çš„å‚è€ƒé“¾æ¥é‡Œé¢è¿˜æœ‰ä¸€äº›å¥‡ç‰¹çš„ç»´æŠ¤æ“ä½œï¼Œæš‚æ—¶æ²¡å­¦ä¹ </li>
<li><a href="http://cassandra.apache.org/doc/latest/operating/compaction.html" target="_blank" rel="noopener">ç»´æŠ¤æ“ä½œå’Œå‹ç¼©</a></li>
</ul>
<h2 id="compacting-sstable-data"><a class="header-anchor" href="#compacting-sstable-data"></a>Compacting SSTable Data</h2>
<p><img src="https://docs.datastax.com/en/cassandra/3.0/cassandra/images/dml_compaction.png" alt="å®˜ç½‘å‹ç¼©æ•°æ®å›¾ç‰‡"></p>
<h3 id="ä¸ºä»€ä¹ˆéœ€è¦compaction"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆéœ€è¦compaction"></a>ä¸ºä»€ä¹ˆéœ€è¦Compaction</h3>
<ul>
<li><code>cassandra</code>å¹¶ä¸ä¼šåˆ é™¤æ•°æ®ã€‚å½“éœ€è¦<code>update</code>ä¸€ä¸ªæ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿä¸æ˜¯åœ¨<code>SSTable</code>é‡Œé¢è¿›è¡Œè¦†ç›–ï¼Œè€Œæ˜¯ä¼šæ’å…¥ä¸€ä¸ªæ–°çš„æ•°æ®ï¼Œå¸¦ä¸Šæ–°çš„<code>version</code>ã€‚</li>
<li>è¿™æ ·åšçš„è¯ï¼Œ<code>cassandra</code>å†™å…¥æ•°æ®ä¼šéå¸¸å¿«ï¼Œå› ä¸ºä¸éœ€è¦æŸ¥è¯¢ï¼Œä½†æ˜¯å¼Šç«¯å°±æ˜¯ä¼šæœ‰è¶Šæ¥è¶Šå¤šçš„æ•°æ®ã€‚</li>
<li>è¿™ä¸ªæ—¶å€™å°±éœ€è¦è¿›è¡Œ<code>compaction</code>ã€‚</li>
</ul>
<h3 id="ä»€ä¹ˆæ˜¯compaction"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯compaction"></a>ä»€ä¹ˆæ˜¯Compaction</h3>
<ul>
<li>To keep the multiple versions of the SSTables from overwhelming it, the database merges SSTables on a regular basis to get rid of the older versions of the dataã€‚ <code>cassandra</code>ä¼šåœ¨ä¸€ä¸ªåŸºç¡€ä¹‹ä¸Šå¯¹æ—§çš„ç‰ˆæœ¬çš„æ•°æ®è¿›è¡Œåˆå¹¶ï¼Œè¿™ä¸ªå°±æ˜¯<code>compaction</code></li>
<li><code>cassandra</code>é»˜è®¤ä¼šè¿›è¡Œå¾ˆå¤šæ¬¡å°çš„<code>compaction</code>ã€‚åœ¨æœ‰æ–°ç”Ÿæˆ<code>SStable</code>çš„æ—¶å€™ï¼Œæˆ–è€…é»˜è®¤5åˆ†é’Ÿä¼šè¿›è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œéœ€ä¸éœ€è¦è¿›è¡Œ<code>minor compaction</code></li>
<li>ä¼šåˆå¹¶åŒä¸€è¡Œçš„ï¼Œä¸åŒç‰ˆæœ¬çš„æ•°æ®ã€‚ä¸åŒç‰ˆæœ¬å¸¦ç€ä¸åŒçš„<code>timestamp</code></li>
</ul>
<h3 id="ä»€ä¹ˆæƒ…å†µä¸‹å¢“ç¢‘ä¼šåœ¨compactionä¸­è¢«ç§»é™¤"><a class="header-anchor" href="#ä»€ä¹ˆæƒ…å†µä¸‹å¢“ç¢‘ä¼šåœ¨compactionä¸­è¢«ç§»é™¤"></a>ä»€ä¹ˆæƒ…å†µä¸‹å¢“ç¢‘ä¼šåœ¨Compactionä¸­è¢«ç§»é™¤</h3>
<ul>
<li>è¿™ä¹Ÿæ˜¯æ¥è‡ªä¸Šç¯‡å‚è€ƒæ–‡æ¡£çš„ã€‚è¿™ç¯‡æ–‡æ¡£æ¯”è¾ƒæ¸…æ¥š</li>
<li>äº‹å®ä¸Šæœ‰å¥½å‡ ä¸ªè¦æ±‚ï¼š
<ul>
<li><code>gc_grace_seconds</code> å·²ç»è¿‡äº†ï¼Œè¿™ç‚¹å·²ç»åœ¨ä¸Šé¢è§£é‡Šè¿‡äº†</li>
<li>_If partition X contains the tombstone, the sstable containing the partition plus all sstables containing data older than the tombstone containing X must be included in the same compaction. We donâ€™t need to care if the partition is in an sstable if we can guarantee that all data in that sstable is newer than the tombstone. If the tombstone is older than the data it cannot shadow that data._è¿™å¥è¯å®åœ¨å¤ªæ‹—å£äº†ï¼Œå«ä¹‰å°±æ˜¯è¯´å¢“ç¢‘å¾—æ˜¯æœ€è€çš„ä¸€ä¸ªï¼Œå¦åˆ™åˆ é™¤ä¸æ‰ï¼Ÿ</li>
<li><code>only_purge_repaired_tombstones</code> è¿™è¿˜æœ‰ä¸€ä¸ªå‚æ•°ï¼Œå¦‚æœä¸æ˜¯repairè¿‡ç¨‹ä¸­çš„å¢“ç¢‘å°±ä¸åˆ é™¤ã€‚è¿™ä¸ªå‚æ•°ä¼°è®¡å¾ˆå°‘ç”¨å§</li>
<li>è¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šæƒ…å†µï¼Œå°±æ˜¯æ•´ä¸ª<code>SSTable</code>é‡Œé¢éƒ½æ˜¯å¢“ç¢‘ï¼Œè¿™ç§æƒ…å†µåœ¨ä»¥æ—¶é—´åºåˆ—çš„è¡¨å¹¶ä¸”ä½¿ç”¨äº†<code>TTL</code>ä¹‹åå¾ˆå®¹æ˜“å‡ºç°ã€‚å¦‚æœæ²¡æœ‰è¢«æ•´è¡¨åˆ é™¤ï¼Œé‚£ä¹ˆå°±åƒä¸Šä¸€ä¸ªbulleté‡Œé¢è®²çš„ï¼Œè¯´æ˜å…¶ä»–è¡¨é‡Œé¢æœ‰æ›´è€çš„æ•°æ®ã€‚æœ‰ä¸€ä¸ªå·¥å…·<code>sstableexpiredblockers</code>å¯ä»¥è¿›è¡ŒæŸ¥è¯¢ã€‚è¿˜æœ‰ä¸€ä¸ªå‚æ•°å¯ä»¥ä½¿ç”¨<code>unsafe_aggressive_sstable_expiration</code>ï¼Œåœ¨ä½¿ç”¨æ—¶é—´å‹ç¼©ç­–ç•¥æ—¶å€™ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥ä¿è¯åˆ é™¤è¿™ç§è¡¨</li>
</ul>
</li>
</ul>
<h3 id="compactionçš„å‚æ•°å’Œå‘½ä»¤"><a class="header-anchor" href="#compactionçš„å‚æ•°å’Œå‘½ä»¤"></a>compactionçš„å‚æ•°å’Œå‘½ä»¤</h3>
<ul>
<li>åœ¨ä¸Šç¯‡é“¾æ¥ä¸­æœ‰ï¼Œåˆ—ä¸€éƒ¨åˆ†ï¼š
<ul>
<li><code>log_all</code>: å¯ä»¥è®°å½•å‹ç¼©çš„æ—¥å¿—</li>
<li><a href="http://cassandra.apache.org/doc/latest/operating/compaction.html" target="_blank" rel="noopener">ç»´æŠ¤æ“ä½œå’Œå‹ç¼©</a></li>
</ul>
</li>
<li>å‘½ä»¤åœ¨ä¸Šé¢çš„é“¾æ¥ä¸­ä¹Ÿæœ‰ï¼Œè¿™è¾¹ä¹Ÿåˆ—ä¸€éƒ¨åˆ†ï¼š
<ul>
<li><code>compactionstats</code>: çŠ¶æ€</li>
<li><code>compactionhistory</code>: å†å²</li>
</ul>
</li>
<li>å¦‚æœæ˜¯åœ¨ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ç³»ç»Ÿä¸­æ”¹å˜è¡¨çš„å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨<code>ALTER TABLE</code>å‘½ä»¤æ¥è¿›è¡Œ</li>
</ul>
<h3 id="å…¶ä»–ä¸€äº›campactionç»†èŠ‚"><a class="header-anchor" href="#å…¶ä»–ä¸€äº›campactionç»†èŠ‚"></a>å…¶ä»–ä¸€äº›Campactionç»†èŠ‚</h3>
<ul>
<li>åœ¨<code>compaction</code>æœŸé—´ï¼Œ<code>cassandra</code>ä¼šåˆå¹¶<code>key</code>å’Œ<code>column</code>ï¼ŒåŒæ—¶ä¼šå°†è¿‡æœŸçš„å¢“ç¢‘åˆ é™¤ï¼Œè¿˜ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„<code>index</code>ï¼Ÿ <strong><em>è¿™ä¸ªindexæ˜¯ä»€ä¹ˆä¸œè¥¿å•Š</em></strong></li>
<li>åˆå¹¶ä¹‹åä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„<code>SSTable</code>ã€‚è€Œä¸éœ€è¦çš„æ•°æ®ç‰ˆæœ¬å’Œè¡Œå°±ä¼šç•™åœ¨æ—§çš„<code>SSTable</code>é‡Œé¢ï¼Œå½“æ­£åœ¨æ‰§è¡Œçš„è¯»æ“ä½œç»“æŸä¹‹åï¼Œå°±å¯ä»¥åˆ é™¤æ‰ã€‚</li>
<li><code>compaction</code>æœŸé—´çš„èµ„æºè€—ç”¨ä¼šä¸Šå‡ï¼Œä½†æ˜¯<code>compaction</code>ç»“æŸä¹‹ååº”è¯¥ä¼šé‡Šæ”¾ç©ºé—´ï¼Œå› ä¸ºå®ƒåˆå¹¶äº†<code>SSTable</code></li>
<li>æ—§çš„è¢«åˆå¹¶çš„<code>table</code>ä¼šè¢«åŠ ä¸Š<code>deletion</code>æ ‡ç­¾ï¼Œå¹¶ä¸”åœ¨æ•°æ®åº“é‡å¯æˆ–è€…åœ¨ä½¿ç”¨<code>reference counting mechanism</code>çš„æ—¶å€™ã€‚<strong><em>è¿™ä¸ª<code>reference counting mechanism</code>æ˜¯ä»€ä¹ˆå•Š</em></strong></li>
<li><code>compaction</code>çš„ç®—æ³•æ˜¯å¯ä»¥é…ç½®çš„ï¼Œé»˜è®¤çš„æ˜¯<code>size-tiered compaction</code>ã€‚è¿™ä¸ªç®—æ³•ä¼šåˆå¹¶å¤§å°ç›¸è¿‘çš„tableï¼Œç”Ÿæˆå¤§table</li>
</ul>
<h3 id="compactionå¯¹è¯»æ•°æ®çš„å½±å“"><a class="header-anchor" href="#compactionå¯¹è¯»æ•°æ®çš„å½±å“"></a>Compactionå¯¹è¯»æ•°æ®çš„å½±å“</h3>
<ul>
<li><code>compaction</code>æ˜¯<code>per-node</code>çš„ï¼Œæ‰€ä»¥æŸä¸ªæ•°æ®åœ¨<code>node1</code>ä¸Šé¢çš„æ—§ç‰ˆæœ¬å¯èƒ½åˆ é™¤äº†ã€‚ä½†æ˜¯åœ¨<code>node2</code>ä¸Šé¢è¿˜æœ‰ã€‚</li>
<li>è¿™æ ·è¯»çš„æ—¶å€™ä¼šè¿›è¡Œä¸€ä¸ªåˆå¹¶ï¼Œå¹¶ä¸”è¿”å›æœ€åä¸€ä¸ªå†™çš„<code>version</code>ã€‚è¿™ä¸ªåŸåˆ™æ˜¯<code>last-write-win</code></li>
<li>Cassandra can read data directly from the new SSTable even before it finishes writing, instead of waiting for the entire compaction process to finish.</li>
</ul>
<h3 id="compaction-ç­–ç•¥"><a class="header-anchor" href="#compaction-ç­–ç•¥"></a>Compaction ç­–ç•¥</h3>
<ul>
<li>ä¸åŒçš„ç­–ç•¥å†³å®šäº†å¦‚ä½•æ¥é€‰æ‹©<code>SSTable</code>ä»¥åŠå‹ç¼©åçš„è¡Œå¦‚ä½•æ’å…¥åˆ°æ–°çš„è¡¨æ ¼ä¸­</li>
<li>æˆ‘åœ¨å‹ç¼©ç­–ç•¥çš„é“è·¯ä¸Šè¶Šèµ°è¶Šè¿œäº†å•Šã€‚ğŸ˜‚</li>
</ul>
<h4 id="sizetieredcompactionstrategy-stcs"><a class="header-anchor" href="#sizetieredcompactionstrategy-stcs"></a>SizeTieredCompactionStrategy (STCS)</h4>
<h5 id="å·¥ä½œæµç¨‹"><a class="header-anchor" href="#å·¥ä½œæµç¨‹"></a>å·¥ä½œæµç¨‹</h5>
<ul>
<li>å½“æœ‰4ä¸ªå¤§å°ç›¸è¿‘çš„<code>STable</code>çš„æ—¶å€™å°±å¼€å§‹åˆå¹¶ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯å®Œå…¨ç›¸åŒå¤§å°çš„</li>
<li>å°†è¿™äº›å¤§å°ç›¸è¿‘çš„<code>SSTable</code>åˆå¹¶æˆä¸€ä¸ªï¼Œå½“æœ‰4ä¸ªæ›´å¤§çš„<code>table</code>çš„æ—¶å€™ï¼Œå†åˆå¹¶æˆæ›´å¤§çš„<code>SSTable</code></li>
<li>æ‰€ä»¥ä¼šæœ‰å¾ˆå¤šå¤§å°ä¸åŒçš„<code>SSTable</code>åŒæ—¶å­˜åœ¨</li>
</ul>
<h4 id="å‚æ•°"><a class="header-anchor" href="#å‚æ•°"></a>å‚æ•°</h4>
<h5 id="ä¼˜ç¼ºç‚¹"><a class="header-anchor" href="#ä¼˜ç¼ºç‚¹"></a>ä¼˜ç¼ºç‚¹</h5>
<ul>
<li>ä¼˜åŠ¿ï¼šå†™å¯†é›†çš„å·¥ä½œè‰¯å¥½ã€‚</li>
<li>é€†åŠ¿ï¼š
<ul>
<li>å¯èƒ½é™ä½è¯»çš„æ•ˆç‡ã€‚å› ä¸ºç­–ç•¥ä¸ä¿è¯åŒä¸€è¡Œçš„æ•°æ®è¢«é™åˆ¶åœ¨æœ‰é™çš„æ•°æ®æ–‡ä»¶é‡Œé¢ï¼Œè¿™æ ·åœ¨è¯»å–çš„æ—¶å€™ä¼šéœ€è¦è¯»å–æ›´å¤šçš„æ•°æ®æ–‡ä»¶ã€‚</li>
<li>å¯èƒ½é•¿æœŸä¿æŒæ—§æ•°æ®ï¼›ä¸åŒç‰ˆæœ¬çš„åŒä¸€è¡Œä¼šå¯èƒ½åˆ†å¸ƒåœ¨ä¸åŒçš„<code>SSTable</code>é‡Œé¢ã€‚å¹¶ä¸”ä¸åˆ©äºåˆ é™¤æ—§æ•°æ®</li>
<li>éœ€è¦çš„å†…å­˜å’Œç£ç›˜éƒ½ä¼šéšç€æ—¶é—´å¢åŠ ã€‚ç£ç›˜åœ¨ä¸‹é¢çš„é—®é¢˜ç« èŠ‚ä¸­å¯ä»¥çœ‹åˆ°ï¼›è€Œå†…å­˜ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œå½“<code>SSTable</code>çš„å¤§å°è¾¾åˆ°ä¸€å®šçº§åˆ«ï¼Œä¸€æ¬¡å‹ç¼©éœ€è¦çš„å†…å­˜ä¼šå¾ˆå¤§ã€‚å› ä¸ºéœ€è¦<code>load SSTable</code>åˆ°å†…å­˜é‡Œé¢</li>
</ul>
</li>
</ul>
<h5 id="é—®é¢˜"><a class="header-anchor" href="#é—®é¢˜"></a>é—®é¢˜</h5>
<ul>
<li>
<p>åœ¨å®é™…çš„å·¥ä½œä¸­ç¢°åˆ°äº†ç¼ºç‚¹ä¸­çš„é—®é¢˜ï¼Œç³»ç»Ÿåœ¨å·¥ä½œ3ä¸ªæœˆçš„æ—¶å€™èƒ½å¤Ÿåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šé¢å ç”¨é 13Gçš„ç£ç›˜é‡ã€‚</p>
</li>
<li>
<p>è§‚å¯Ÿä¸‹æ¥ï¼Œå…¶å®ç­–ç•¥æ˜¯åœ¨æ­£å¸¸å·¥ä½œçš„ã€‚é‡Œé¢æ˜æ˜¾èƒ½å¤Ÿçœ‹åˆ°å¤§å°ä¸åŒçš„dataæ–‡ä»¶ã€‚</p>
</li>
<li>
<p>ç°åœ¨å®¢æˆ·çš„éœ€æ±‚æ˜¯ä¸æ‰‹åŠ¨æ“ä½œæ¥è§£å†³å ç”¨ç£ç›˜çš„é—®é¢˜ã€‚æ€»çš„æ¥è¯´ï¼Œè²Œä¼¼ä¸ç°å®ï¼Œæ¯•ç«Ÿå¤šæ•°å»ºè®®æ˜¯å…³é—­è‡ªåŠ¨SSTableå‹ç¼©ï¼Œæ”¹ç”¨æ‰‹åŠ¨åœ¨ç©ºé—²æœŸé—´è¿›è¡Œå‹ç¼©</p>
<pre><code>total 13G
 115M Jan 24  2019 la-2421-big-Data.db
 101M Jan 24  2019 la-2443-big-Data.db
 453K Jan 24  2019 la-2447-big-Data.db
 124M Feb  3 14:47 lb-5276-big-Data.db
 216M Feb  3 14:54 lb-5280-big-Data.db
 235M Feb  3 14:54 lb-5281-big-Data.db
 680M Feb  4 11:24 lb-5294-big-Data.db
 781M Feb  4 11:36 lb-5295-big-Data.db
 2.8G Feb  4 11:54 lb-5296-big-Data.db
 3.3G Feb  4 12:52 lb-5298-big-Data.db
 3.5G Feb  4 12:54 lb-5297-big-Data.db
</code></pre>
</li>
</ul>
<h4 id="leveledcompactionstrategy-lcs"><a class="header-anchor" href="#leveledcompactionstrategy-lcs"></a>LeveledCompactionStrategy (LCS)</h4>
<h5 id="å·¥ä½œæµç¨‹-v2"><a class="header-anchor" href="#å·¥ä½œæµç¨‹-v2"></a>å·¥ä½œæµç¨‹</h5>
<ul>
<li>
<p>LCSçš„å·¥ä½œæµç¨‹æ˜¯æœ€ä¸æ¸…æ™°çš„äº†ã€‚ç½‘ä¸Šå„ç±»æ–‡ç« ï¼Œæœ‰è¯´L1çš„æ•°æ®æ–‡ä»¶æ•°é‡æ˜¯L0çš„10å€çš„ï¼Œæœ‰è¯´æ•´ä½“å¤§å°çš„ã€‚æˆ‘ä¸€å£è¡€éƒ½è¦å–·æ˜¾ç¤ºå™¨ä¸Šé¢äº†,ä¸å¸¦è¿™ä¹ˆä¸ä¸¥è°¨çš„å¥½å˜› ğŸ˜¦</p>
</li>
<li>
<p>çœ‹ä»£ç å…¶å®æœ€æ¸…æ¥šäº†ã€‚åº”è¯¥æ˜¯å¤§å°ï¼Œä¸æ˜¯æ•°é‡ï¼š</p>
</li>
<li>
<p>ä»¥ä¸‹ä»£ç é‡Œé¢ï¼ŒmaxSSTableSizeInBytes= 160M * 1024<em>1024ï¼Œæ‰€ä»¥L0æœ€å¤§æ˜¯160M</em>4</p>
</li>
<li>
<p>ä»£ç åœ¨<code>org.apache.cassandra.db.compaction.LeveledCompactionStrategy</code></p>
<pre><code>public static long maxBytesForLevel(int level, int levelFanoutSize, long maxSSTableSizeInBytes) {
  if (level == 0) {
      return 4L * maxSSTableSizeInBytes;
  } else {
      double bytes = Math.pow((double)levelFanoutSize, (double)level) * (double)maxSSTableSizeInBytes; 
  }
}
</code></pre>
</li>
<li>
<p><code>LCS</code>ä¸€å¤§ç‰¹ç‚¹æ˜¯ä¼šå°½é‡ä¿è¯åœ¨åŒä¸€ä¸ªå±‚çº§é‡Œé¢ï¼ŒåŒä¸€<code>partition key</code>çš„æ•°æ®åœ¨åŒä¸€å¼ <code>SSTable</code>è¡¨é‡Œé¢ã€‚å½“ç„¶<code>L0</code>æ²¡æ³•ä¿è¯ï¼Œå› ä¸ºè¿™ä¸€å±‚çº§æ˜¯<code>flush</code>æ¥çš„</p>
</li>
<li>
<p>ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œ<code>LCS</code>åœ¨è¿›è¡Œä¸€æ¬¡å‹ç¼©çš„æ—¶å€™ä¼šåŒ…æ‹¬ä¸Šä¸€çº§ä¸­ä¹Ÿæœ‰è¿™ä¸ª<code>partition key</code>çš„æ•°æ®ï¼Œæ‰€ä»¥è¿™ä¸ªç­–ç•¥è¦è¯»è¡¨å•Šã€‚æ¯”å¦‚åœ¨<code>L1</code>çº§æ•°æ®å¤§äºä¸Šé™éœ€è¦å‹ç¼©çš„æ—¶å€™ï¼Œ<code>L2</code>çº§ä¸­åŒ…å«ç›¸åŒ<code>key</code>çš„è¡¨ä¹Ÿè¦è¢«ä¸€èµ·åˆå¹¶ï¼Œä½†æ˜¯æ¬£æ…°çš„æ˜¯ï¼Œåº”è¯¥ä¹Ÿåªæœ‰ä¸€å¼ è¡¨ã€‚æ¯•ç«Ÿæ¯ä¸€çº§éƒ½æ˜¯è¿™ä¹ˆå¹²çš„ã€‚-</p>
</li>
<li>
<p>æˆ‘ä»¬åœ¨<code>Cassandra</code>ä¸­å¯ä»¥è®¾å®šè¿›è¡Œå¹¶è¡Œçš„å‹ç¼©ï¼Œé‚£ä¹ˆåœ¨<code>LCS</code>ç­–ç•¥ä¸­éœ€è¦ä¿è¯åŒä¸€ä¸ª<code>parititon key</code>çš„æ•°æ®åªåœ¨ä¸€ä¸ªå‹ç¼©çº¿ç¨‹ä¸­ï¼Œä¸èƒ½æœ‰äº¤å‰é‡å </p>
</li>
<li>
<p>æ‰€ä»¥ï¼Œå‹ç¼©<code>L0</code>å±‚çº§çš„æ—¶å€™ï¼Œä¼šå¸¦ä¸Šæ‰€æœ‰<code>L1</code>çš„è¡¨ä¸€èµ·å‹ç¼©ã€‚å¦‚æœ<code>L0</code>å¾ˆå¤šï¼Œé‚£ä¹ˆæ²¡æ³•ä¸€æ¬¡å‹ç¼©åšå®Œæ‰€æœ‰<code>L0</code>çš„è¡¨æ ¼</p>
</li>
<li>
<p>å‹ç¼©æ—¶å€™ä¼˜å…ˆè€ƒè™‘æœ€é«˜çº§åˆ«çš„ã€‚æ‰€æœ‰<code>L0</code>æ˜¯æœ€åè€ƒè™‘çš„ä¸€ä¸ªå±‚çº§</p>
</li>
<li>
<p><code>LCS</code>æœ‰å¯èƒ½è§¦å‘<code>major compaction</code>ï¼Œè¿™ç‚¹éœ€è¦è¿›ä¸€æ­¥è€ƒå¯Ÿã€‚</p>
</li>
<li>
<p>å¦‚æœ<code>L0</code>çº§åˆ«çš„è¡¨è¶…è¿‡32ä¸ªï¼Œä¼šè¿›è¡Œ<code>STCS</code></p>
</li>
</ul>
<h5 id="ç›¸å…³å‚æ•°"><a class="header-anchor" href="#ç›¸å…³å‚æ•°"></a>ç›¸å…³å‚æ•°</h5>
<ul>
<li><code>sstable_size_in_mb</code>: å°±æ˜¯ä¸Šé¢ä»£ç é‡Œé¢é‚£ä¸ª<code>maxSSTableSizeInBytes</code>ï¼Œç¬¬ä¸€å±‚çº§çš„å¤§å°</li>
<li><code>fanout_size</code>ï¼š å„ä¸ªå±‚çº§ä¹‹é—´çš„å·®å¼‚ï¼Œä¸Šé¢ä»£ç é‡Œé¢çš„<code>levelFanoutSize</code></li>
</ul>
<h5 id="ä¼˜ç¼ºç‚¹-v2"><a class="header-anchor" href="#ä¼˜ç¼ºç‚¹-v2"></a>ä¼˜ç¼ºç‚¹</h5>
<ul>
<li>ä¼˜ç‚¹ï¼š
<ul>
<li>è¯»æ¯”è¾ƒé¢‘ç¹çš„æ›´æ¨èè¿™ä¸ªç®—æ³•ã€‚å…¶å®å†™çš„åº”è¯¥ä¹Ÿå¯ä»¥ã€‚ç›®å‰è¿™åº”è¯¥æ˜¯åº”ç”¨æœ€å¹¿æ³›çš„å‹ç¼©ç®—æ³•äº†ã€‚</li>
<li>å®¹æ˜“é¢„æµ‹å†…å­˜éœ€æ±‚å¤§å°</li>
<li>æ›´å®¹æ˜“åˆ é™¤æ—§æ•°æ®</li>
<li>éœ€è¦çš„ç£ç›˜ç©ºé—´æ›´å°</li>
</ul>
</li>
<li>ç¼ºç‚¹ï¼š
<ul>
<li>è¿›è¡Œå¾—æ›´ä¸ºé¢‘ç¹ï¼Œæ‰€ä»¥éœ€è¦çš„I/Oæ¯”è¾ƒå¤š</li>
</ul>
</li>
</ul>
<h4 id="timewindowcompactionstrategy-twcs"><a class="header-anchor" href="#timewindowcompactionstrategy-twcs"></a>TimeWindowCompactionStrategy (TWCS)</h4>
<ul>
<li>æ¥ä¸Šæ–‡ç¢°åˆ°çš„é—®é¢˜ï¼Œåˆšåˆšå¥½å‡ºé—®é¢˜çš„è¡¨çš„<code>partition key</code>æ˜¯æ—¥æœŸï¼Œæ‰€ä»¥ç ”ç©¶å¾—æœ€å¤šçš„å°±æ˜¯è¿™ä¸ªç­–ç•¥äº†ã€‚è€Œæ—¶é—´ç­–ç•¥æ˜¯å”¯ä¸€ä¸€ä¸ªå¯ä»¥å½»åº•åˆ é™¤è¿‡æœŸçš„è¡¨çš„ç­–ç•¥ã€‚å½“ç„¶ï¼Œè¦ç»“åˆä¸‹é¢çš„<code>TTL</code>ä¸€èµ·ç”¨ã€‚</li>
<li>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼š<code>TCWS</code>æ˜¯ä»<code>Cassandra 3.0.8</code>æ‰è¢«å¼•å…¥çš„ã€‚è€Œæˆ‘ä»¬äº§å“ä»æ—§åœç•™åœ¨<code>2.2.8</code>ä¸Šï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæœ€åæ²¡æ³•é‡‡ç”¨è¿™ä¸ªè§£å†³æ–¹æ¡ˆ</li>
</ul>
<h5 id="å·¥ä½œåŸç†"><a class="header-anchor" href="#å·¥ä½œåŸç†"></a>å·¥ä½œåŸç†</h5>
<ul>
<li>è¿™ä¸ªç®—æ³•æŒºæœ‰æ„æ€çš„ï¼Œè€Œä¸”ç®€å•å¥½æ‡‚ã€‚å°±æ˜¯è¯´åœ¨ä¸€æ®µæ—¶é—´å†…ï¼Œæ¯”å¦‚ä¸€ä¸ªå°æ—¶å†…ï¼Œä½¿ç”¨<code>STCS</code>ç®—æ³•ï¼Œç„¶ååœ¨æ—¶é—´ç‚¹ä¸Šï¼Œä¸€ä¸ªå°æ—¶ç»“æŸçš„æ—¶å€™ï¼ŒæŠŠè¿™ä¸ªå°æ—¶å†…çš„éƒ½å‹æˆä¸€ä¸ªå¤§çš„æ•°æ®æ–‡ä»¶ã€‚</li>
<li>ç¬¬äºŒä¸ªå°æ—¶å¼€å§‹çš„æ—¶å€™ï¼Œé‡æ–°ç®—èµ·ï¼Œä¸Šä¸€ä¸ªå°æ—¶å‹å‡ºæ¥çš„å¤§è¡¨å°±æ”¾é‚£é‡Œä¸åŠ¨äº†ã€‚</li>
</ul>
<h5 id="ç›¸å…³å‚æ•°-v2"><a class="header-anchor" href="#ç›¸å…³å‚æ•°-v2"></a>ç›¸å…³å‚æ•°</h5>
<ul>
<li><code>compaction_window_unit</code>:MINUTES, HOURS, or DAYS</li>
<li><code>compaction_window_size</code>:é»˜è®¤ä¸º1</li>
<li><code>unsafe_aggressive_sstable_expiration</code>: è¿™ä¸ªå‚æ•°å¾ˆæœ‰æ„æ€ï¼Œå°±æ˜¯è¯´å½“ä¸€ä¸ªè¡¨é‡Œé¢éƒ½æ˜¯å¢“ç¢‘çš„æ—¶å€™ï¼Œç›´æ¥æŠŠè¡¨åˆ é™¤æ‰ã€‚è¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå…¨å±€å‚æ•°ï¼Œæ˜¯åœ¨å¯åŠ¨<code>JVM</code>çš„æ—¶å€™è®¾ç½®çš„ã€‚å› ä¸ºæ˜¯æœ‰é£é™©çš„ï¼Œæœ‰å¯èƒ½é€ æˆå¹½çµæ•°æ®ã€‚åŒæ—¶ï¼Œè®¾ç½®è¿™ä¸ªå‚æ•°ä¼šè¦†ç›–æ‰<code>unchecked_tombstone_compaction</code>.</li>
</ul>
<h5 id="å‚è€ƒé“¾æ¥-v2"><a class="header-anchor" href="#å‚è€ƒé“¾æ¥-v2"></a>å‚è€ƒé“¾æ¥</h5>
<ul>
<li><a href="https://thelastpickle.com/blog/2016/12/08/TWCS-part1.html" target="_blank" rel="noopener">TWCS-part1</a></li>
<li><a href="https://thelastpickle.com/blog/2017/01/10/twcs-part2.html" target="_blank" rel="noopener">TWCS-part2</a></li>
</ul>
<h3 id="ttl"><a class="header-anchor" href="#ttl"></a>TTL</h3>
<h4 id="ttlè¢«æå‡ºçš„èƒŒæ™¯"><a class="header-anchor" href="#ttlè¢«æå‡ºçš„èƒŒæ™¯"></a>TTLè¢«æå‡ºçš„èƒŒæ™¯</h4>
<ul>
<li>è¿™æ˜¯åœ¨å¤„ç†äº§å“çš„ä¸€ä¸ªé—®é¢˜çš„æ—¶å€™è¢«æå‡ºçš„ï¼Œè¯¥é—®é¢˜å°±æ˜¯ï¼Œç”±äºæŸä¸ªç»Ÿè®¡åŠŸèƒ½ä¸€ç›´åœ¨å†™æ•°æ®ï¼Œç„¶åæ¯éš”ä¸€ä¸ªæœˆå·¦å³ä¼šåˆ é™¤æ•°æ®ã€‚</li>
<li>è¡¨æ ¼ä»¥<code>date</code>ä½œä¸º<code>partition key</code>ï¼Œæ‰€æœ‰æ•°æ®åœ¨ä¸€ä¸ªè¡¨é‡Œé¢ï¼Œæ‰€ä»¥å³ä½¿æ•°æ®è¢«åˆ é™¤äº†ä¹Ÿæ²¡æ³•ç›´æ¥<code>truncate</code>è¡¨ï¼Œåªèƒ½ä¾èµ–<code>Cassandra</code>çš„<code>compaction</code>ã€‚</li>
<li>æœ€åè¶Šæ¥è¶Šå ç£ç›˜ã€‚ä½¿ç”¨çš„ç­–ç•¥æ˜¯é»˜è®¤çš„<code>STCS</code>ã€‚ç„¶åå°±æœ‰å¤§ä½¬æäº†<code>TTL</code></li>
<li>æˆ‘åŸæœ¬åœ¨è€ƒè™‘åŠ <code>crontab job</code>ï¼Œä½†æ˜¯å…¶å®æ²¡æœ‰æ„ä¹‰ï¼Œå› ä¸º<code>Cassandra</code>æä¾›çš„å…¶å®å°±æ˜¯ç±»ä¼¼åŠŸèƒ½ã€‚</li>
</ul>
<h4 id="ä»€ä¹ˆæ˜¯ttl-time-to-live"><a class="header-anchor" href="#ä»€ä¹ˆæ˜¯ttl-time-to-live"></a>ä»€ä¹ˆæ˜¯TTL(time-to-live)</h4>
<ul>
<li><em>TTL: allows to specify an optional Time To Live (in seconds) for the inserted values. If set, the inserted values are automatically removed from the database after the specified time. Note that the TTL concerns the inserted values, not the column themselves. This means that any subsequent update of the column will also reset the TTL (to whatever TTL is specified in that update). By default, values never expire. A TTL of 0 or a negative one is equivalent to no TTL.</em></li>
<li>å…¶å®<code>Cassandra</code>é‡Œé¢<code>TTL</code>çš„æ¦‚å¿µåˆ°å¤„éƒ½æ˜¯ã€‚ä½†æ˜¯é€šå¸¸è¯´çš„<code>TTL</code>æ˜¯æŒ‡å‚æ•°<code>default_time_to_live</code>ï¼Œä¹Ÿå°±æ˜¯è¯´åˆ°äº†è¿™ä¸ªæ—¶é—´ç‚¹ï¼Œ<code>Cassandra</code>ä¼šè‡ªåŠ¨å°†æ•°æ®åˆ é™¤æ‰ã€‚</li>
<li>é»˜è®¤å€¼ä¸º0ï¼Œä¹Ÿå°±æ˜¯<code>Cassandra</code>ä¼šè®¤ä¸ºè¿™ä¸ªæ•°æ®ä¸€ç›´æœ‰æ•ˆ</li>
<li>è¿™ä¸ªå‚æ•°åœ¨<code>desc tables</code>é‡Œé¢å¯ä»¥çœ‹åˆ°ï¼Œä½†æ˜¯æˆ‘ä»¬äº§å“çš„å¼‚æ­¥æ¨¡å—é‡Œé¢å…¶å®åœ¨ä»£ç é‡Œé¢è¿›è¡Œäº†è¦†ç›–ã€‚<code>java</code>ä»£ç é‡Œé¢å¼„äº†ä¸ªç³»ç»Ÿå‚æ•°ï¼Œåœ¨æ’å…¥æ•°æ®çš„æ—¶å€™ä»£å…¥äº†è¿™ä¸ªå‚æ•°</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/hexo_blog/tags/Cassandra/" rel="tag"># Cassandra</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/hexo_blog/2019/06/17/%E8%BD%AF%E4%BB%B6%E8%A1%A1%E9%87%8F%E6%A0%87%E5%87%86/" rel="prev" title="è½¯ä»¶è¡¡é‡æ ‡å‡†">
      <i class="fa fa-chevron-left"></i> è½¯ä»¶è¡¡é‡æ ‡å‡†
    </a></div>
      <div class="post-nav-item">
    <a href="/hexo_blog/2019/07/09/JVM-tool/" rel="next" title="JVMç›¸å…³">
      JVMç›¸å…³ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒé“¾æ¥"><span class="nav-number">1.</span> <span class="nav-text">å‚è€ƒé“¾æ¥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#delete-data"><span class="nav-number">2.</span> <span class="nav-text">Delete Data</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆ é™¤æŸä¸€è¡Œçš„æŸä¸ªæ•°æ®"><span class="nav-number">2.1.</span> <span class="nav-text">åˆ é™¤æŸä¸€è¡Œçš„æŸä¸ªæ•°æ®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆ é™¤ä¸€è¡Œçš„æ•°æ®"><span class="nav-number">2.2.</span> <span class="nav-text">åˆ é™¤ä¸€è¡Œçš„æ•°æ®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆ é™¤ä¸€ä¸ªèŒƒå›´å†…çš„æ•°æ®"><span class="nav-number">2.3.</span> <span class="nav-text">åˆ é™¤ä¸€ä¸ªèŒƒå›´å†…çš„æ•°æ®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆ é™¤ä¸€ä¸ªpartitionçš„æ•°æ®"><span class="nav-number">2.4.</span> <span class="nav-text">åˆ é™¤ä¸€ä¸ªpartitionçš„æ•°æ®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é›†åˆæ•°æ®"><span class="nav-number">2.5.</span> <span class="nav-text">é›†åˆæ•°æ®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gc-grace-secondså‚æ•°"><span class="nav-number">2.6.</span> <span class="nav-text">gc_grace_secondså‚æ•°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç»´æŠ¤æ“ä½œ"><span class="nav-number">3.</span> <span class="nav-text">ç»´æŠ¤æ“ä½œ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#compacting-sstable-data"><span class="nav-number">4.</span> <span class="nav-text">Compacting SSTable Data</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸ºä»€ä¹ˆéœ€è¦compaction"><span class="nav-number">4.1.</span> <span class="nav-text">ä¸ºä»€ä¹ˆéœ€è¦Compaction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä»€ä¹ˆæ˜¯compaction"><span class="nav-number">4.2.</span> <span class="nav-text">ä»€ä¹ˆæ˜¯Compaction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä»€ä¹ˆæƒ…å†µä¸‹å¢“ç¢‘ä¼šåœ¨compactionä¸­è¢«ç§»é™¤"><span class="nav-number">4.3.</span> <span class="nav-text">ä»€ä¹ˆæƒ…å†µä¸‹å¢“ç¢‘ä¼šåœ¨Compactionä¸­è¢«ç§»é™¤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#compactionçš„å‚æ•°å’Œå‘½ä»¤"><span class="nav-number">4.4.</span> <span class="nav-text">compactionçš„å‚æ•°å’Œå‘½ä»¤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å…¶ä»–ä¸€äº›campactionç»†èŠ‚"><span class="nav-number">4.5.</span> <span class="nav-text">å…¶ä»–ä¸€äº›Campactionç»†èŠ‚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#compactionå¯¹è¯»æ•°æ®çš„å½±å“"><span class="nav-number">4.6.</span> <span class="nav-text">Compactionå¯¹è¯»æ•°æ®çš„å½±å“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#compaction-ç­–ç•¥"><span class="nav-number">4.7.</span> <span class="nav-text">Compaction ç­–ç•¥</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sizetieredcompactionstrategy-stcs"><span class="nav-number">4.7.1.</span> <span class="nav-text">SizeTieredCompactionStrategy (STCS)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#å·¥ä½œæµç¨‹"><span class="nav-number">4.7.1.1.</span> <span class="nav-text">å·¥ä½œæµç¨‹</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#å‚æ•°"><span class="nav-number">4.7.2.</span> <span class="nav-text">å‚æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ä¼˜ç¼ºç‚¹"><span class="nav-number">4.7.2.1.</span> <span class="nav-text">ä¼˜ç¼ºç‚¹</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#é—®é¢˜"><span class="nav-number">4.7.2.2.</span> <span class="nav-text">é—®é¢˜</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#leveledcompactionstrategy-lcs"><span class="nav-number">4.7.3.</span> <span class="nav-text">LeveledCompactionStrategy (LCS)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#å·¥ä½œæµç¨‹-v2"><span class="nav-number">4.7.3.1.</span> <span class="nav-text">å·¥ä½œæµç¨‹</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ç›¸å…³å‚æ•°"><span class="nav-number">4.7.3.2.</span> <span class="nav-text">ç›¸å…³å‚æ•°</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ä¼˜ç¼ºç‚¹-v2"><span class="nav-number">4.7.3.3.</span> <span class="nav-text">ä¼˜ç¼ºç‚¹</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#timewindowcompactionstrategy-twcs"><span class="nav-number">4.7.4.</span> <span class="nav-text">TimeWindowCompactionStrategy (TWCS)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#å·¥ä½œåŸç†"><span class="nav-number">4.7.4.1.</span> <span class="nav-text">å·¥ä½œåŸç†</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ç›¸å…³å‚æ•°-v2"><span class="nav-number">4.7.4.2.</span> <span class="nav-text">ç›¸å…³å‚æ•°</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#å‚è€ƒé“¾æ¥-v2"><span class="nav-number">4.7.4.3.</span> <span class="nav-text">å‚è€ƒé“¾æ¥</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ttl"><span class="nav-number">4.8.</span> <span class="nav-text">TTL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ttlè¢«æå‡ºçš„èƒŒæ™¯"><span class="nav-number">4.8.1.</span> <span class="nav-text">TTLè¢«æå‡ºçš„èƒŒæ™¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ä»€ä¹ˆæ˜¯ttl-time-to-live"><span class="nav-number">4.8.2.</span> <span class="nav-text">ä»€ä¹ˆæ˜¯TTL(time-to-live)</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Lynn Shen</p>
  <div class="site-description" itemprop="description">35å²å¼€å§‹çš„åšå®¢ï¼Œæœ‰ç‚¹æ™šå“¦</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/hexo_blog/archives/">
        
          <span class="site-state-item-count">42</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/hexo_blog/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">æ ‡ç­¾</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lynn Shen</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"ffyWzhHueqJEC5UEfPUhAWzF-MdYXbMMI","app_key":"vS7xTvT1vD1DxluERkmlkvme","server_url":"https://sallyslove.github.io/hexo_blog","security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/hexo_blog/lib/anime.min.js"></script>
  <script src="/hexo_blog/lib/velocity/velocity.min.js"></script>
  <script src="/hexo_blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/hexo_blog/js/utils.js"></script>

<script src="/hexo_blog/js/motion.js"></script>


<script src="/hexo_blog/js/schemes/muse.js"></script>


<script src="/hexo_blog/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'ffyWzhHueqJEC5UEfPUhAWzF-MdYXbMMI',
      appKey     : 'vS7xTvT1vD1DxluERkmlkvme',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
